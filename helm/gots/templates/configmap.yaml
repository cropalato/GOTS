apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "gots.fullname" . }}
  labels:
    {{- include "gots.labels" . | nindent 4 }}
data:
  config.yaml: |
    okta:
      domain: {{ .Values.okta.domain | quote }}
      {{- if eq .Values.okta.authMethod "api_token" }}
      auth_method: api_token
      api_token: ${OKTA_API_TOKEN}
      {{- else if eq .Values.okta.authMethod "oauth" }}
      auth_method: oauth
      oauth:
        client_id: ${OKTA_CLIENT_ID}
        {{- if .Values.okta.oauth.clientSecret }}
        client_secret: ${OKTA_CLIENT_SECRET}
        {{- end }}
        token_endpoint_auth_method: {{ .Values.okta.oauth.tokenEndpointAuthMethod | quote }}
        {{- if or .Values.okta.oauth.privateKey .Values.okta.oauth.privateKeySecretName }}
        private_key_path: ${OKTA_PRIVATE_KEY_PATH}
        {{- end }}
        scopes:
          {{- range .Values.okta.oauth.scopes }}
          - {{ . | quote }}
          {{- end }}
      {{- end }}

    grafana:
      url: {{ .Values.grafana.url | quote }}
      api_key: ${GRAFANA_API_KEY}

    sync:
      interval_seconds: {{ .Values.sync.intervalSeconds }}
      dry_run: {{ .Values.sync.dryRun }}
      {{- if .Values.sync.admin_groups }}
      admin_groups:
        {{- range .Values.sync.admin_groups }}
        - {{ . | quote }}
        {{- end }}
      {{- end }}
      mappings:
        {{- range .Values.sync.mappings }}
        - okta_group: {{ .okta_group | quote }}
          grafana_team: {{ .grafana_team | quote }}
        {{- end }}
